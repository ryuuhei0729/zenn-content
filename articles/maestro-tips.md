---
title: "【Maestro】動的な出力を簡単にアサーションするtips"
emoji: "👻"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Maestro", "E2Eテスト", "モバイルアプリ", "QA", "テスト自動化"]
published: false
---

## はじめに

こんにちは、株式会社GLOBISでe-learningアプリのQAを担当している細井です。

我々のチームではモバイルアプリのE2Eテストに**Maestro**を導入しています。しかし、実践的なTips記事がまだ少ないため、自分が実装する中で発見した便利なテクニックをまとめておきます！

:::message
Maestroはオープンソースで発展途上のツールです。今後より良い方法が発見される可能性があります。その際は追記・更新していきますので、ぜひブックマークしてください🙋‍♂️
:::

https://maestro.mobile.dev/

## 📌 この記事で解決できること

- 動的に変化するテキストをアサーションしたい
- ハードコーディングを避けてメンテナンスしやすいテストを書きたい
- スマートにMaestroのテストコードを書きたい

---

## 🎯 E2Eテストの基本構造

まず、E2Eテストの超基本的な動作を確認しましょう。テストは**操作 → 確認**の2ステップで行われます。

### 具体例：画面遷移のテスト

**テストシナリオ**
> トップ画面からカテゴリ画面に遷移し、コース詳細画面に遷移できることを確認する

| 手順 | 操作内容 | Maestroコマンド |
|---------|---------|----------------|
| 1 | カテゴリ「思考・コミュニケーション」をタップ | `tapOn: "思考・コミュニケーション"` |
| 2 | コース名をタップ | `tapOn: "最短理解MBA クリティカル・シンキング"` |
| 3 | 遷移を確認 | `assertVisible: コース詳細`,<br> `assertVisible: 最短理解MBA　クリティカル・シンキング` |

```yaml
# サンプルコード
- tapOn: "思考・コミュニケーション"
- tapOn: "最短理解MBA　クリティカル・シンキング"
- assertVisible: コース詳細
- assertVisible: 最短理解MBA　クリティカル・シンキング
```

:::message
**💡 補足**：上記の例ではテキストベースで要素取得を取得していますが、もちろんIDを振って取得することも可能です。

各プラットフォームでのID設定方法は公式ドキュメントを参照してください👇

https://maestro.mobile.dev/platform-support/supported-platforms

**対応プラットフォーム一覧**
| プラットフォーム | フレームワーク |
|----------------|---------------|
| Android | Views / Jetpack Compose |
| iOS | UIKit / SwiftUI |
| クロスプラットフォーム | React Native / Flutter / .NET MAUI |
| Web | Web Views / Desktop Browser |
:::

---

## 😱 ハードコーディングの問題点

上記のテストには、ビジネス要件によって**失敗するリスク**があります。

### 想定される問題

| 問題 | 発生するケース |
|------|---------------|
| ❌ テスト失敗 | コースが非公開になった |
| ❌ テスト失敗 | コース名が1文字でも変更された |
| ❌ メンテナンスコスト増 | コンテンツ変更のたびにテストコード修正が必要 |

---

## ✅ 解決策：クリップボードを活用した動的アサーション

そこで、**動的に取得したテキストでアサーションする**手法を紹介します。

### 💡 ポイント

:::message
**1. IDを用いて要素を取得する**
テキストベースではなく、IDで要素を特定することで安定したテストに

**2. コピー機能でクリップボードを活用してアサーション**
`copyTextFrom` でコピーしたテキストを `${maestro.copiedText}` で再利用
:::

### 実装コード

```yaml
# コースタイトル(IDで取得)をクリップボードにコピー
- copyTextFrom: 
    id: course-title
    index: 0

# 同じ要素をタップして画面遷移
- tapOn: 
    id: course-title
    index: 0

# クリップボードの内容でアサーション
- assertVisible: ${maestro.copiedText}
```

### 解説

1. **`copyTextFrom`** - 並んでいるコースタイトルにIDを振り、その1番目の要素のテキストをクリップボードにコピー
2. **`tapOn`** - 同じ要素をタップして画面遷移
3. **`assertVisible: ${maestro.copiedText}`** - クリップボードに保存されたテキストで遷移先画面をアサーション

:::message
`${maestro.copiedText}` はMaestro組み込みの変数で、直前にコピーしたテキストを保持しています。
:::

---

## 📊 この手法のメリット

| メリット | 説明 |
|---------|------|
| ✅ メンテナンスフリー | コンテンツが変更されてもテストコードの修正不要 |
| ✅ コード量削減 | 変数定義や外部ファイル参照が不要 |
| ✅ 可読性向上 | テストの意図が明確 |

---

## まとめ

現状、**クリップボードを活用したアサーション**が、最も行数が少なく動的なアサーションができる手法かと思います。

ぜひ皆さんのプロジェクトでも試してみてください！

---

## 参考リンク

- [Maestro 公式ドキュメント](https://maestro.mobile.dev/)
- [copyTextFrom コマンドリファレンス](https://maestro.mobile.dev/api-reference/commands/copytextfrom)